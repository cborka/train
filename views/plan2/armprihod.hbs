<form action="/plan2/armprihod/update" method="POST" >
<div>
    <table class="form">
        <tr>
            <td><label>Код документа:</label></td>
            <td><input id="doc_id" type="text" name="doc_id" readonly value={{doc_id}} >
                <input id="old_doc_id" type="text" name="old_doc_id" readonly value={{doc_id}} hidden >
            </td>
        </tr>
        <tr>
            <td><label>Дата и время ГГГГ-ММ-ДД ЧЧ:ММ</label></td>
            <td><input id="dt" type="text" name="dt" value="{{dt}}" ></td>
        </tr>
        <tr>
            <td><label>Подразделение:</label></td>
            <td><select width="100%" size="1" name='sd_name' id='sd_name' value="{{sd_name}}"></select>
                <input id="sd_rf" type="text" name="sd_rf" readonly value={{sd_rf}} hidden >
                <input id="old_sd_rf" type="text" name="old_sd_rf" readonly value={{sd_rf}} hidden >
            </td>
        </tr>
        <tr>
            <td></td>
            <td>
                <button type="submit" >Сохранить</button>
            </td>
        </tr>
        <tr>
            <td></td>
            <td>
                <div id="hint" ></div>
                <div id="xxxxxxxxxxxerro" ></div>
            </td>
        </tr>
    </table>
</div>

<button type="button" onclick="reload_page(this)">Reload</button>

<div>
    <table id="doc_lines" class="list">
        <tr>
            <td class="list"><b>Арматура</b></td>
            <td class="list"><b>Количество</b></td>
            <td class="list">Кнопки</td>
        </tr>

        <tr><td><input  style="width:100%; height:100%; border: 0" type="text"></td>
            <td></td>
        </tr>

        {{#each data.table}}
            <tr>
                <td class="list">{{arm_rf}}</td>
                <td class="list ed">{{arm_num}}</td>
                <td class="list">
                    <button type="button" onclick="armprihod({{doc_id}},{{arm_rf}} )">Изменить</button>
                    <button type="button" onclick="delete_armprihod({{doc_id}},{{arm_rf}},{{arm_name}})">Удалить</button>
                </td>
            </tr>
        {{/each}}
    </table>
    <button type="button" onclick="add_line(this)">Добавить строку</button>
</div>
</form>
<br>
<br><br>
<select class='xy td' size="1" name="arm_name" id="arm_name"  ondblclick="setval(this)" xonchange="setval(this)"></select>
<br>
<br>
<div id="erro" ></div>

<script>
    //pattern='[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}'

    var gcell;
    var si = document.getElementById("arm_name");

    si.onkeyup = onk;
    si.onabort = function () { this.style.visibility = 'hidden'; };
    si.onblur = function () { this.style.visibility = 'hidden'; }

    function onk(f) {
      if (f.keyCode == 13) setval(this);
      else if (f.keyCode == 27) this.onblur();
    }

    function setval(t) {

        erro('-->'+t.value);
//        alert('-->'+gcell);
        gcell.innerHTML = t.value;

        si.style.visibility = 'hidden';
//        si.style.top = 5 + 'px';
//        si.style.left = 5 + 'px';


    }

    function getCoords(elem) { // кроме IE8-
        var box = elem.getBoundingClientRect();

        return {
            top: box.top + pageYOffset,
            left: box.left + pageXOffset
        };

    }

    function select_arm(t)
    {
//        si = document.getElementById("arm_name");
        si.style.visibility = 'visible';
        si.focus();
//        si.value = 'В500С  d8';

        gcell = t.parentNode.cells[0];
        si.value = gcell.innerHTML;

        c = getCoords(gcell);

        si.style.top = c.top + 5 + 'px';
        si.style.left = c.left + 5 + 'px';

        si.size = 10;
        erro('-->'+gsell);
//        erro(c.top + ',' + c.left);
    }

    function add_line(t)
    {
        tt = t.parentNode.parentNode.parentNode;
        tb = document.getElementById("doc_lines");

        tb.innerHTML += '<tr> \
                       <td class="input" ondblclick="select_arm(this)"></td> \
                       <td class="input right" contenteditable >123</td> \
                       <td><button type="button" onclick="deleted_line(this)">Удалить строку</button></td> \
    </tr> ';

//    <td class="input"><button type="button" onclick="select_arm(this.parentNode)">...</button> </td>

        //       alert(tt.innerHTML + tt.type + tt.className);
    }



    function deleted_line(t)
    {
        tt = t.parentNode.parentNode;
        tt.innerHTML = '';
    }

    function butclick(t)
    {
        alert(t.innerHTML + t.type + t.onclick);
    }
    function reload_page(t)
    {
        location.reload(true);
    }



    // Изготовить список арматуры для выбора
    var set_arm_names = function (reply)
    {
//      alert(reply);
//        document.getElementById("arm_name").innerHTML = reply;
        si.innerHTML = reply;
        si.style.visibility = 'hidden';
//        document.getElementById("arm_name").value = ' '; //{{arm_name}}';
    }
    function get_arm_names()
    {
        doQuery ("/common/get_spr_names/Арматура", set_arm_names);
    }
    // Изготовить список планов для выбора
    var set_plan_names = function (reply)
    {
        document.getElementById("plan_name").innerHTML = reply;
        document.getElementById("plan_name").value = '{{plan_name}}';
    }
    function get_plan_names()
    {
        doQuery ("/common/get_spr_names/Планы", set_plan_names);
    }

    // Изготовить список подразделений для выбора
    var set_sd_names = function (reply)
    {
        document.getElementById("sd_name").innerHTML = reply;
        document.getElementById("sd_name").value = '{{sd_name}}';
    }
    function get_sd_names()
    {
        doQuery ("/common/get_spr_names/Подразделения", set_sd_names);
    }

    // Изготовить список ЖБИ для выбора
    var set_item_names = function (reply)
    {
        document.getElementById("item_name").innerHTML = reply;
        document.getElementById("item_name").value = '{{item_name}}';
    }
    function get_item_names()
    {
//        doQuery ("/common/get_all_items", set_item_names);
        doQuery ("/common/get_spr_names/{{spr_name}}", set_item_names);
    }
   get_arm_names();
//    get_plan_names();
    get_sd_names();
//    get_item_names();

</script>


<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>