<H2>План производства ЖБИ</H2>
План производства ЖБИ согласно календарю рабочего времени.<br>
<br>
<form action="/plan2/plan_plan_d/update" method="POST" >
    <table class="form">
        <tr>
            <td><label>План-месяц:</label></td>
            <td><select width="100%" size="1" name='plan_name' id='plan_name' value="{{plan_name}}" onchange="change_plan_name()"></select>
                <input id="plan_name2" type="text" name="plan_name2" readonly value="{{plan_name}}" hidden >
                <input id="plan_rf" type="text" name="plan_rf" readonly value={{plan_rf}} hidden >
                <input id="old_plan_rf" type="text" name="old_plan_rf" readonly value={{plan_rf}} hidden >

                <input id="doc_list_form" type="text" name="doc_list_form" readonly value="plan_plan_d2_s" hidden >
            </td>
        </tr>
        <tr>
            <td><label>Подразделение:</label></td>
            <td><select width="100%" size="1" name='sd_name' id='sd_name' value="{{sd_name}}" onchange="on_change_sd_name()"></select>
                <input id="sd_name2" type="text" name="sd_name2" readonly value="{{sd_name}}" hidden >
                <input id="sd_rf" type="text" name="sd_rf" readonly value={{sd_rf}} hidden >
                <input id="old_sd_rf" type="text" name="old_sd_rf" readonly value={{sd_rf}} hidden >
            </td>
        </tr>
        <tr>
            <td><label>Предмет:</label></td>
            <td>
                <select width="100%" size="1" name='item_name' id='item_name' value="{{item_name}}" onchange="on_change_item_name()"></select>
                <input id="item_rf" type="text" name="item_rf" readonly value={{item_rf}} hidden >
                <input id="old_item_rf" type="text" name="old_item_rf" readonly value={{item_rf}} hidden >
                
                <input id="spr_name" type="text" name="spr_name" readonly value={{spr_name}} hidden >
            </td>
        </tr>
        <tr>
            <td><label>Количество ЖБИ на план:</label></td>
            <td><input id="num_plan" type="number" name="num_plan" step="0.5" value={{num_plan}} ></td>
        </tr>
        <!--
        <tr>
            <td><label>Количество на день:</label></td>
            <td><input id="num_day" type="number" name="num_day" step="0.001" value={{num_day}} ></td>
        </tr>
-->
    </table>
    <br>
    Количество ЖБИ по дням месяца
    <button type="button" onclick="calc_num_days()">Рассчитать</button>
    <br>
    <table id="table_days" class="form">
        <tr>
            <td><label>1</label>  <span class="comment" id="h1"></span> </td>
            <td><label>2</label>  <span class="comment" id="h2"></span> </td>
            <td><label>3</label>  <span class="comment" id="h3"></span> </td>
            <td><label>4</label>  <span class="comment" id="h4"></span> </td>
            <td><label>5</label>  <span class="comment" id="h5"></span> </td>
            <td><label>6</label>  <span class="comment" id="h6"></span> </td>
            <td><label>7</label>  <span class="comment" id="h7"></span> </td>
        </tr>
        <tr>
            <td><input class="day" id="np1" type="number" name="np1" step="0.5" value={{np1}} ></td>
            <td><input class="day" id="np2" type="number" name="np2" step="0.5" value={{np2}} ></td>
            <td><input class="day" id="np3" type="number" name="np3" step="0.5" value={{np3}} ></td>
            <td><input class="day" id="np4" type="number" name="np4" step="0.5" value={{np4}} ></td>
            <td><input class="day" id="np5" type="number" name="np5" step="0.5" value={{np5}} ></td>
            <td><input class="day" id="np6" type="number" name="np6" step="0.5" value={{np6}} ></td>
            <td><input class="day" id="np7" type="number" name="np7" step="0.5" value={{np7}} ></td>
        </tr>
        <tr>
            <td><label>8</label>  <span class="comment" id="h8"></span> </td>
            <td><label>9</label>  <span class="comment" id="h9"></span> </td>
            <td><label>10</label>  <span class="comment" id="h10"></span> </td>
            <td><label>11</label>  <span class="comment" id="h11"></span> </td>
            <td><label>12</label>  <span class="comment" id="h12"></span> </td>
            <td><label>13</label>  <span class="comment" id="h13"></span> </td>
            <td><label>14</label>  <span class="comment" id="h14"></span> </td>
        </tr>
        <tr>
            <td><input class="day" id="np8" type="number" name="np8" step="0.5" value={{np8}} ></td>
            <td><input class="day" id="np9" type="number" name="np9" step="0.5" value={{np9}} ></td>
            <td><input class="day" id="np10" type="number" name="np10" step="0.5" value={{np10}} ></td>
            <td><input class="day" id="np11" type="number" name="np11" step="0.5" value={{np11}} ></td>
            <td><input class="day" id="np12" type="number" name="np12" step="0.5" value={{np12}} ></td>
            <td><input class="day" id="np13" type="number" name="np13" step="0.5" value={{np13}} ></td>
            <td><input class="day" id="np14" type="number" name="np14" step="0.5" value={{np14}} ></td>
        </tr>
        <tr>
            <td><label>15</label>  <span class="comment" id="h15"></span> </td>
            <td><label>16</label>  <span class="comment" id="h16"></span> </td>
            <td><label>17</label>  <span class="comment" id="h17"></span> </td>
            <td><label>18</label>  <span class="comment" id="h18"></span> </td>
            <td><label>19</label>  <span class="comment" id="h19"></span> </td>
            <td><label>20</label>  <span class="comment" id="h20"></span> </td>
            <td><label>21</label>  <span class="comment" id="h21"></span> </td>
        </tr>
        <tr>
            <td><input class="day" id="np15" type="number" name="np15" step="0.5" value={{np15}} ></td>
            <td><input class="day" id="np16" type="number" name="np16" step="0.5" value={{np16}} ></td>
            <td><input class="day" id="np17" type="number" name="np17" step="0.5" value={{np17}} ></td>
            <td><input class="day" id="np18" type="number" name="np18" step="0.5" value={{np18}} ></td>
            <td><input class="day" id="np19" type="number" name="np19" step="0.5" value={{np19}} ></td>
            <td><input class="day" id="np20" type="number" name="np20" step="0.5" value={{np20}} ></td>
            <td><input class="day" id="np21" type="number" name="np21" step="0.5" value={{np21}} ></td>
        </tr>
        <tr>
            <td><label>22</label>  <span class="comment" id="h22"></span> </td>
            <td><label>23</label>  <span class="comment" id="h23"></span> </td>
            <td><label>24</label>  <span class="comment" id="h24"></span> </td>
            <td><label>25</label>  <span class="comment" id="h25"></span> </td>
            <td><label>26</label>  <span class="comment" id="h26"></span> </td>
            <td><label>27</label>  <span class="comment" id="h27"></span> </td>
            <td><label>28</label>  <span class="comment" id="h28"></span> </td>
        </tr>
        <tr>
            <td><input class="day" id="np22" type="number" name="np22" step="0.5" value={{np22}} ></td>
            <td><input class="day" id="np23" type="number" name="np23" step="0.5" value={{np23}} ></td>
            <td><input class="day" id="np24" type="number" name="np24" step="0.5" value={{np24}} ></td>
            <td><input class="day" id="np25" type="number" name="np25" step="0.5" value={{np25}} ></td>
            <td><input class="day" id="np26" type="number" name="np26" step="0.5" value={{np26}} ></td>
            <td><input class="day" id="np27" type="number" name="np27" step="0.5" value={{np27}} ></td>
            <td><input class="day" id="np28" type="number" name="np28" step="0.5" value={{np28}} ></td>
        </tr>
        <tr>
            <td><label>29</label>  <span class="comment" id="h29"></span> </td>
            <td><label>30</label>  <span class="comment" id="h30"></span> </td>
            <td><label>31</label>  <span class="comment" id="h31"></span> </td>
        </tr>
        <tr>
            <td><input class="day" id="np29" type="number" name="np29" step="0.5" value={{np29}} ></td>
            <td><input class="day" id="np30" type="number" name="np30" step="0.5" value={{np30}} ></td>
            <td><input class="day" id="np31" type="number" name="np31" step="0.5" value={{np31}} ></td>
        </tr>
    </table>

    <button id="btn_calc_num_days" type="button" onclick="calc_num_days()">Рассчитать план по дням равномерно</button><br>
    <button id="btn_calc_num_days" type="button" onclick="calc_num_days2()">Рассчитать план по дням по кол-ву форм и времени пропарки</button><br>
    <button type="button" onclick="paint_num_days()">Дни недели</button>
    <button id="btn_submit" title="" type="submit" ><b>Сохранить</b></button>

    <br>
    <div id="hint" ></div>
    <div id="erro" ></div>
</form>
<br>
<div class="left" id="sd_params" >
    <br><button type="button" onclick="get_sd_params()"> >> </button>
    Параметры пролёта: <br>
    <table class="form">
        <tr>
            <td><label>Рабочих дней:</label></td>
            <td><input  class="day" id="days_num" type="number" name="days_num" onchange="on_change_sd_params()"></td>
        </tr>
        <tr>
            <td><label>Работников:</label></td>
            <td><input  class="day" id="workers_num" type="number" name="workers_num" onchange="on_change_sd_params()"></td>
        </tr>
        <tr>
            <td><label>Рем.день:</label></td>
            <td><select width="100%" size="1" name='rem_day_name' id='rem_day_name' value="Пятница" onchange="on_change_sd_params()"></select></td>
        </tr>
        <tr>
            <td><label>% раб.времени</label></td>
            <td><input  class="day" id="rem_time_proc" type="number" name="rem_time_proc" title="% рабочего времени в рем.день" step="0.001" value="25" onchange="on_change_sd_params()">%</td>
        </tr>
        <tr>
            <td><label>Часов раб.времени в день</label></td>
            <td><input  class="day" id="working_hours" type="number" name="working_hours" title="Рабочих часов в сутки" step="0.001" value="22" onchange="on_change_sd_params()"></td>
        </tr>
    </table>
    <span id="plan_sd_params"></span>
    <br><button type="button" id="btn_save_sd_params" disabled="true" onclick="save_sd_params()" >Сохранить параметры</button>
    <div id="save_sd_params_error" ></div>
</div>

<div class="left" id="fc_params" >
    <br><button type="button" onclick="get_params()"> >> </button>
    Параметры ЖБИ: <br>
    <table class="form">
        <tr>
            <td><label>Форма (оснастка):</label></td>
<!--            <td><b><span id="xform_name">xxx</span></b></td> -->
            <td><select width="100%" size="1" name='form_name' id='form_name' value="" onchange="on_change_sd_params()"></select></td>
        </tr>
        <tr>
            <td><label>Кол-во ЖБИ в 1 форме:</label></td>
            <td><input  class="day" id="form_fc_num" type="number" name="form_fc_num" onchange="on_change_sd_params()"></td>
        </tr>
        <tr>
            <td><label>Время формовки:</label></td>
            <td><input  class="day" id="forming_time" type="number" name="forming_time" onchange="on_change_sd_params()"></td>
            <td><button type="button" id="btn_save_form_params1" disabled="true" onclick="save_form_fc_params()" >Сохранить</button></td>
        </tr>
        <tr> <td><hr></td><td><hr></td></tr>
        <tr>
            <td><label>Кол-во форм в пролёте</label></td>
            <td><input  class="day" id="sd_form_num" type="number" name="sd_form_num" onchange="on_change_sd_params()"></td>
        </tr>
        <tr>
            <td><label>Макс. кол-во форм в пролёте</label></td>
            <td><input  class="day" id="sd_form_num_max" type="number" name="sd_form_num_max" onchange="on_change_sd_params()"></td>
            <td><button type="button" id="btn_save_form_params1" disabled="true" onclick="save_sd_form_params()" >Сохранить</button></td>
        </tr>
        <tr> <td><hr></td><td><hr></td></tr>
    </table>
    <span id="plan_fc_params"></span>
</div>



<script>
    var plan_name = '{{plan_name}}';
    var sd_name = '{{sd_name}}';
    var item_name = '{{item_name}}';
    var form_name = '';
    var dtc = new Date();
    var dtb = PlanFirstDate(plan_name);
    var i = 0;
    var j = 0;
    var k = 0;
    var month_days = PlanLastDay(plan_name);

    var hours = [1,2,3];

    var sd_params_exists = false;

    //
    // При изменении ключевых полей
    //
    function on_change_plan_name() {
        plan_name = document.getElementById("plan_name").value;
        document.getElementById("plan_name2").value = document.getElementById("plan_name").value;
//        alert(plan_name);
        paint_num_days ();
        get_sd_params();
    }
    function on_change_sd_name() {
        sd_name = document.getElementById("sd_name").value;
        document.getElementById("sd_name2").value = document.getElementById("sd_name").value;
        get_sd_params();
    }

    function on_change_item_name() {
        item_name = document.getElementById("item_name").value;
    }

    //
    // Раскрасить календарь
    //
    function paint_num_days ()
    {
        // dtc = new Date();
        dtb = PlanFirstDate(plan_name);
        dtc = dtb;

        month_days = PlanLastDay(plan_name);

        for (i=1; i<=month_days; i++){
            dtc.setDate(dtc.getDate() + 1);
            k = dtc.getDay(); // (dtb.getDate()+i).getDay;
            //              alert(k);
//            document.getElementById("np"+i).value = k; //dtc.getDay(); // (dtb.getDate()+i).getDay;
            if (k > 1)
                document.getElementById("np"+i).style.backgroundColor = 'white';
            if (k == 0)
                document.getElementById("np"+i).style.backgroundColor = 'khaki'; //  Суббота
            if (k == 1)
                document.getElementById("np"+i).style.backgroundColor = 'lightpink'; //  Воскресенье
        }
        //  Несуществующие дни
        for (i=month_days+1; i<=31; i++){
            dtc.setDate(dtc.getDate() + 1);
            k = dtc.getDay(); // (dtb.getDate()+i).getDay;
            document.getElementById("np"+i).value = 0; //dtc.getDay(); // (dtb.getDate()+i).getDay;
            document.getElementById("np"+i).style.backgroundColor = 'lightgrey';
        }
    }


    // Расчитать кол-во ЖБИ по дням месяца
    function calc_num_days ()
    {

        if(!confirm("Пересчитать кол-во по дням? Уверены?")) return;

        var nps = document.getElementById("num_plan").value;
        var npd = nps / 31;
        var npds = npd;
        var npr = Math.round(npds);

        for (i=30; i>=1; i--){

//            npd = Math.round(npd);
//            document.getElementById("np"+i).value = npd; //Math.round(npd);
//            npd = Math.round(npd);

            document.getElementById("np"+i).value = npr;
            nps = nps - npr;
            npds = npds + npd - npr;
            npr = Math.round(npds);

//            npd = nps / i;
//            npd = nps / (31-i);
        }
        document.getElementById("np31").value = nps; //Math.round(npd);

        nps = 0;
        for (i=1; i<=31; i++){
            nps = nps + +document.getElementById("np"+i).value;
        }

        document.getElementById("hint").innerHTML = "Сумма по дням: " + nps;

//        document.getElementById("np5").value = 12;
    }

    // Расчитать кол-во ЖБИ по дням месяца
    // в ссответствии с кол-вом форм и временем пропарки
    /*
       обнуляем дни

       1. прибавляем к началу времени плана время пропарки, запоминаем датувремя
       2. получаем дату
       3. в полученной дате прибавляем кол-во = кол-во форм * кол-во изделий в одной форме
       4. вычитаем данное кол-во из кол-ва на план, запоминаем сколько осталось сделать

       если изделия или дни не закончились, то  идем к шагу 1


     */
    function calc_num_days2 ()
    {

        if(!confirm("Пересчитать кол-во по дням в ссответствии с кол-вом форм и временем пропарки? Уверены?")) return;

        return;

        var nps = document.getElementById("num_plan").value;
        var npd = nps / 31;
        var npds = npd;
        var npr = Math.round(npds);

        for (i=30; i>=1; i--){

//            npd = Math.round(npd);
//            document.getElementById("np"+i).value = npd; //Math.round(npd);
//            npd = Math.round(npd);

            document.getElementById("np"+i).value = npr;
            nps = nps - npr;
            npds = npds + npd - npr;
            npr = Math.round(npds);

//            npd = nps / i;
//            npd = nps / (31-i);
        }
        document.getElementById("np31").value = nps; //Math.round(npd);

        nps = 0;
        for (i=1; i<=31; i++){
            nps = nps + +document.getElementById("np"+i).value;
        }

        document.getElementById("hint").innerHTML = "Сумма по дням: " + nps;

//        document.getElementById("np5").value = 12;
    }





    //
    // При корректировке дней пересчитывать план на месяц.
    //
    function make_table_days()
    {
        for (i=1; i<=31; i++){
            document.getElementById("np"+i).onchange = sum_days;
        }
    }
    make_table_days();
    function sum_days()
    {
        nps = 0;
        for (j=1; j<=31; j++) {
            nps = nps + +document.getElementById("np" + j).value;
        }
//        document.getElementById("hint").innerHTML = "Сумма по дням: " + nps;
        document.getElementById("num_plan").value = nps;
    }

    //
    // Получение параметров пролёта
    //
    var set_sd_params = function (reply)
    {
        // 2018-07|Пролет 33|22.00|35.00|Четверг|25.000
//        document.getElementById("plan_sd_params").innerHTML = reply;
        sd_params_exists = (reply.substr(0, 6) != 'ОШИБКА');

        var arr_sd = reply.split('|');
        document.getElementById("days_num").value = arr_sd[2];
        document.getElementById("workers_num").value = arr_sd[3];
        document.getElementById("rem_day_name").value = arr_sd[4];
        document.getElementById("rem_time_proc").value = arr_sd[5];
        document.getElementById("plan_rf").innerHTML = arr_sd[6];
        document.getElementById("sd_rf").innerHTML = arr_sd[7];
    };
    function get_sd_params()
    {
        doQuery ("/plan2/get_plan_plan_d_sd_params", set_sd_params,
                "&plan_name=" + encodeURIComponent(document.getElementById("plan_name").value)+
                "&sd_name=" + encodeURIComponent(document.getElementById("sd_name").value)
        );
    }

    //
    // При изменении параметров пролета
    //
    function on_change_sd_params()
    {
        document.getElementById("btn_save_sd_params").disabled = false;
        document.getElementById("btn_submit").disabled = true;
    }

    function save_sd_params_reply(reply) {
        if (reply == 'OK') {
            document.getElementById("btn_save_sd_params").disabled = true;
            document.getElementById("btn_submit").disabled = false;
        }

        document.getElementById("save_sd_params_error").innerHTML = reply;
    }
    function save_sd_params()
    {
        doQuery ("/plan2/save_sd_params", save_sd_params_reply,
                "&sd_params_exists=" + encodeURIComponent(sd_params_exists)+
                "&plan_name=" + encodeURIComponent(document.getElementById("plan_name").value)+
                "&sd_name=" + encodeURIComponent(document.getElementById("sd_name").value) +
                "&days_num=" + encodeURIComponent(document.getElementById("days_num").value) +
                "&workers_num=" + encodeURIComponent(document.getElementById("workers_num").value) +
                "&rem_day_name=" + encodeURIComponent(document.getElementById("rem_day_name").value) +
                "&rem_time_proc=" + encodeURIComponent(document.getElementById("rem_time_proc").value)+
                // Если параметров ещё нет и надо вставлять новые, то передаю даты начала и конца плана,
                // если обновление, то они там не понадобятся
                "&dtb=" + encodeURIComponent(plan_name+'-01')+
                "&dte=" + encodeURIComponent(plan_name+'-'+month_days)
        );
    }



    //
    // Получение параметров ЖБИ
    //
    var set_fc_params = function (reply)
    {
        // 467|ПДН-14|1.0|12.00|48|56
        // (data.form_rf+'|'+data.form_name+'|'+data.form_fc_num+'|'+data.forming_time+'|'+data.sd_form_num+'|'+data.sd_form_num_max);
//        document.getElementById("plan_fc_params").innerHTML = reply;
        var arr_fc = reply.split('|');
        document.getElementById("form_name").value = arr_fc[1];
        document.getElementById("form_fc_num").value = arr_fc[2];
        document.getElementById("forming_time").value = arr_fc[3];
        document.getElementById("sd_form_num").value = arr_fc[4];
        document.getElementById("sd_form_num_max").value = arr_fc[5];
    };
    function get_fc_params()
    {
        doQuery ("/plan2/get_plan_plan_d_fc_params", set_fc_params,
                "&fc_rf=" + encodeURIComponent(document.getElementById("item_rf").value)+
                "&sd_rf=" + encodeURIComponent(document.getElementById("sd_rf").value)
        );
    }

    //
    // Получение кол-ва рабочих часов по дням месяца
    //
    var set_hours = function (reply)
    {
        // 467|ПДН-14|1.0|12.00|48|56
        // (data.form_rf+'|'+data.form_name+'|'+data.form_fc_num+'|'+data.forming_time+'|'+data.sd_form_num+'|'+data.sd_form_num_max);
//        document.getElementById("plan_fc_params").innerHTML = reply;

        // alert(reply);

        hours = reply.split(',');
        for (i=1; i<=31; i++){
            document.getElementById("h"+i).innerHTML = hours[i-1];
        }


    };
    function get_hours()
    {
        doQuery ("/plan2/get_working_hours", set_hours,
                "&plan_name=" + encodeURIComponent(document.getElementById("plan_name").value)+
                "&sd_name=" + encodeURIComponent(document.getElementById("sd_name").value)
        );
    }

    //
    //  ИЗГОТОВЛЕНИЕ СПИСКОВ ДЛЯ ВЫБОРА
    //
    // Изготовить список планов для выбора
    //
    var set_plan_names = function (reply)
    {
        document.getElementById("plan_name").innerHTML = reply;
        document.getElementById("plan_name").value = plan_name;
        document.getElementById("plan_name2").value = plan_name;
    };
    function get_plan_names()
    {
        doQuery ("/common/get_spr_names/Планы", set_plan_names);
    }

    // Изготовить список подразделений для выбора
    var set_sd_names = function (reply)
    {
        document.getElementById("sd_name").innerHTML = reply;
        document.getElementById("sd_name").value = sd_name;
        document.getElementById("sd_name2").value = sd_name;
    };
    function get_sd_names()
    {
        doQuery ("/common/get_spr_names/Подразделения", set_sd_names);
    }

    // Изготовить список ПРЕДМЕТОВ для выбора
    var set_item_names = function (reply)
    {
        document.getElementById("item_name").innerHTML = reply;
        document.getElementById("item_name").value = item_name;
    };
    function get_item_names()
    {
//        doQuery ("/common/get_all_items", set_item_names);
        doQuery ("/common/get_spr_names/{{spr_name}}", set_item_names);
    }

    // Изготовить список дней недели для выбора
    var set_wd_names = function (reply)
    {
        document.getElementById("rem_day_name").innerHTML = reply;
//        document.getElementById("rem_day_name").value = item_name;
    };
    function get_wd_names()
    {
        doQuery ("/common/get_week_days", set_wd_names);
    }

    // Изготовить список ФОРМ для выбора
    var set_form_names = function (reply)
    {
        document.getElementById("form_name").innerHTML = reply;
//        document.getElementById("form_name").value = form_name;
    };
    function get_form_names()
    {
        doQuery ("/common/get_spr_names/ФормыЖБИ", set_form_names);
    }


    // Инициализация значений при добавлении НОВОГО календаря
    function init()
    {
        if (plan_name == '') {
            plan_name = toYYYYMM(dtc);
        }
        else {
            // Запрет кооректировки, убрал, вдруг перекинуть надо в другой пролет
//            document.getElementById("plan_name").disabled = true;
//            document.getElementById("sd_name").disabled = true;
        }



    }

    get_form_names();
    get_wd_names();

    init();

    get_plan_names();
    get_sd_names();
    get_item_names();

    setTimeout(get_sd_params, 1000);
    setTimeout(get_fc_params, 1100);
    setTimeout(get_hours, 1200);



</script>